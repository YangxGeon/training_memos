# DAY 1

## 강사 소개

이름: 최국현

메일: tang@linux.com

## 메모 및 자료 파일 내려받기

[메모](https://github.com/tangt64/training_memos)
>opensource-101
>>oci-docker-101
>>>20240311-memo.md
>>>20240311-files

__google:__ "hyper-v create nat switch"


## 하이퍼브이 에이전트 설치(가상머신)

```bash
dnf search hyperv
dnf install hyperv* -y 
reboot 
```


```
                                [1:1]
     fedora --->        centos  <---> RHEL
[rolling update]       --------
                           \
                            `---> centos-stream    --->     RHEL
                                [rolling update]        [down stream]
```


## 도커 설치

```bash
dnf -y install dnf-plugins-core
dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
dnf install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl start docker
docker run hello-world
docker ps -a
> 8358b98078fc   hello-world   "/hello"   6 seconds ago   Exited (0) 5 seconds ago             pensive_merkle
```

## 포드만 설치(podman-vm)

```bash
dnf install podman -y
podman run hello-world
podman ps -a
> 4ca98c55c1a6  quay.io/podman/hello:latest  /usr/local/bin/po...  3 seconds ago  Exited (0) 4 seconds ago              admiring_kirch
```

## 기술 및 용어 설명

1. container runtime/engine

docker-engine
---
컨테이너 생성 및 관리는 하지 않음. 엔진은 일반적으로 두 가지 형태로 작업을 요청받음.

1. API
2. Socket

```bash
   .--- k8s와 상관 없음 --.                 .-----> K8S사용 가능
  /                       \               /
docker ps -- <API> --> [dockerd] ---> [containerd]
                        daemon
```

## docker runtime(rootless)

```bash
[containerd] ---> [runc] ---> [conmon] ---> <container>
```

## cri-docker(mirantis docker)

현재 도커는 두개로 분리. 기존 도커 시스템(docker-ee, docker-ce)그대로 유지하며, cri-docker로 별도로 구성. 현재 쿠버네티스는 두 가지 도컨 런타임을 지원. 


## podman-engine(daemonless,rootless)
---
포드만은 별도로 엔진이 없음. 포드만 데스크탑 혹은 TUI기반으로 사용시 사용이 가능.


## 정리

- __컨테이너 엔진:__ 일반적으로 개발용이나 혹은 독립적으로 사용하는 시스템.
- __컨테이너 런타임:__ 일반적으로 컨테이너를 실행 및 관리하는 시스템. 
- __daemonless/rootless:__ 현재 오픈소스는 엔진도 데몬리스 형태로 지원하고 있음. 도커는 아직 데몬리스 형태를 제공하지 않음.  


### 1. Podman, Docker

#### Podman

오픈소스 버전의 Docker라고 보시면 됨. 도커하고 결이 맞지 않아서.

- Containerfile
- podman == docker
- docker search == skopeo
- docker build == buildah(공식은 빌더)

#### Docker

클로즈드 버전의 컨테이너 엔진. 루트리스 컨테이너 엔진 및 런타임 원조. 단점이라고 하면, 엔진 및 런타임이 무거움. 

- Dockerfile

### 2. namespace

호스트 프로세스(userspace)를 격리하는 커널 영역. 가상 자원을 커널에서 생성해서 사용자 프로세스에 전달 및 공유.

1. 가상장치 제공(mnt, net, ipc, time)
2. 분리 및 격리
3. 사용자 영역(userspace)에서 발생한 데이터를 커널로 전달해주는 역할.
4. 링 구조

```bash

container --- subuid/gid --- namespace uid/gid

  systemd
     |
  systemd
   |    \
   |  [namespace]
   |     |
   |    <container_user>
[sshd]       |
         |
          `container(binary) + [cgroup]
               \
                `---> cracked!!

```

### 3. cgroup

초기 컨테이너는 __"cgroup"__ 기반으로 구현 및 구성. 구글에서 작성 후, 리눅스 커뮤니티에 기여. BSD에서 __"chroot"__ 기반으로 컨테이너 비슷하게 구성. "cgroup"를 통해서 프로세스 추적 및 감사. 도커 및 포드만에서는 모든 "cgroup"자원을 제어가 가능하지만, 쿠버네티스에서는 "cpu", "mem"만 가능. 

```bash

## docker, podman은 모든 영역 지원
## kubernetes는 "cpu", "memory"만 지원

container(binary)  + cgroup(policy)
   \                     \
    `---> cpu(k8s)        `---> cpu: 1000, memory: 500kib
          memory(k8s)
          disk
          network
```
### 4. OCI/CRI/CNI

__CRI:__ __Container Runtime Interface__ 를 통해서 연결. 다만, 도커는 CRI인터페이스를 제공하지 않음. 어뎁터를 통해서 __containerd__ 를 통해서 쿠버네티스와 연결 제공. 명령어는 현재 도커 명령어를 표준으로 사용. 

__OCI:__ Open Container Initiative, 많이 다루는 부분은 이미지. 흔히 말하는 컨테이너 이미지. 컨테이너 이미지는 overlay기반으로 구성. overlay는 일종의 디렉터리 바인딩 기술(컨테이너 이미지 마운트).

__CNI:__ Container Network Interface, 이를 통해서 컨테이너에서 사용하는 네트워크(infra network, container network)를 제공.


## centos 7 저장소 및 도커 저장소

만약, "containerd", "docker"를 최신 버전으로 사용을 원하는 경우, 무조건 __docker 저장소__ 를 등록해야 합니다.

```bash

## 저장소 미러준비

# 내부 저장소 서버 주소: 10.10.10.5

yum install createrepo createrepo_c -y    ## 미러링 도구
mkdir -p /opt/rpms
cd /opt/rpms
reposync .                                ## /etc/yum.repos.d에 등록되어 있는 모든 저장소.
createrepo .

yum repolist
> repo id
> docker-ce-stable
reposync -r docker-ce-stable              ## 만약, 특정 저장소만 받고 싶은 경우.
createrepo .

yum install httpd -y
vi /etc/httpd/conf.d/httpd.conf
> DocumentRoot /var/www/html --> /opt/rpms/
systemctl restart httpd


# 10.10.5.10, 내부 docker클라이언트
#

rm -f /etc/yum.repos.d/*.repo
vi /etc/yum.repos.d/internal-docker-repos.repo
[internal-docker-repos]
name=internal-docker
baseurl=https://10.10.10.5/
baseurl=files:///opt/rpms/
enabled=1
gpgcheck=0
yum repolist 
yum search docker

```


### Podman에서 도커 명령어 및 호환성

```bash
dnf install podman-tui podman-docker podman-compose -y
```

### 저장소 정보

docker는 저장소 정보를 여러분이 별도로 __"docker.json"__ 를 생성 후 설정. 기본값은 무조건 "hub.docker.io".

podman는 저장소 정보가 __"/etc/containers/registries.conf"__ 저장이 되어 있음.

```bash
grep -Ev '^#|^$' /etc/containers/registries.conf
unqualified-search-registries = ["docker.io", "quay.io"]
short-name-mode="enforcing"
```


### 컨테이너 생성 및 종료


```bash
docker run centos                                 ## hub.docker.io
docker run quay.io/centos/centos:stream8          ## quay.io

docker -d  ## detach
       -i  ## interative
       -t  ## tty(ptty)

docker run quay.io/centos/centos:stream8          ## 실행하자마자 종료
docker ps -a                                      ## 종료된 프로세스 확인     
docker run quay.io/centos/centos:stream8 sleep 100000   ## 컨테이너 이름을 임의로 생성
docker run -d --name centos-test --rm quay.io/centos/centos:stream8 sleep 10000
                                 ----
                                 \
                                  `---> 중지되자마자 삭제
docker stop centos-test                           ## 1개 중지
docker ps -qa                                     ## 컨테이너 sha아이디 출력
docker rm $(docker ps -qa)                        ## 중지된 모든 컨테이너 제거
docker rm centos-test

docker images
> <리스트 확인>
docker rmi <IMAGE_ID>/<IMAGE_NAME>

```

## 테스트2

```bash
docker pull quay.io/centos7/httpd-24-centos7
docker pull quay.io/centos7/httpd-24-centos7:latest
docker images

docker run -d --rm --name test-httpd-24 quay.io/centos7/httpd-24-centos7
docker run -d --rm --name test-httpd-24 -p 8080:8080 quay.io/centos7/httpd-24-centos7
```

컨테이너에서 말하는 이미지는 "프로그램 런타임". 바이너리 동작하는 환경.


## 표준 vs Docker


```bash

podman ---> conmon ---> runc ---> [container]


docker ---> dockerd ---> containerd ---> containerd-shim-runc-v2 ---> [container]
                            \
                             `---> docker-proxy [network]

```

# DAY 2

## 이미지 및 컨테이너 생성/관리


[런타임 변경](https://docs.docker.com/engine/alternative-runtimes/)


- Dockerfile: Docker 표준 이미지 빌드. OCI표준. 기본적으로 도커 런타임에서만 사용. 'docker build'
- Containerfile: OCI에서는 Containerfile기반으로 이미지 빌드 제공. 'buildah', 'podman build'.


### commit(이미지 레이어 통합)

```bash
docker run -d --name build-centos --rm quay.io/centos/centos:stream8 sleep 10000

docker  docker commit build-centos localhost:cus-httpd-2-1

```

### 이미지 저장 및 불러오기.


```bash
docker save bc27ef4eea90 -o cus-httpd-2-1.tar
docker save bc27ef4eea90 > cus-httpd-2-1.tar
> /var/lib/docker/에 저장된 내용을 파일로 빼오기. OCI이미지는 tar로 저장.

file cus-httpd-2-1.tar
> POSIX tar...
mkdir cus-httpd-2-1
tar xf cus-httpd-2-1.tar -C cus-httpd-2-1/

docker rmi cus-httpd-2-1

docker load -o cus-httpd-2-1.tar

docker tag bc27ef4eea90 testimage:v1
           ------------ --------- --
           이미지 이름   이름       테그
           이미지 아이디
docker tag testimage:v1 localhost/testimage/httpd:v1           
> 1. 이름 변경

docker tag localhost/testimage/httpd:v1 images.example.com/tang/centos-httpd:2.4
> 2. 다른 서버로 업로드를 위한 테그 준비

docker push images.example.com/tang/centos-httpd:2.4
> 3. 다른 서버로 업로드

docker top <CONTAINER_ID>
> 

docker history bc27ef4eea90
> 내부에서 설치한 패키지나 파일에 대해서는 알수가 없음.


```

```bash
FROM ubuntu                     ## 기본 이미지, OS템플릿
     scratch                    ## /sys, /proc, /tmp, /etc/hosts, /etc/hostname
RUN mkdir -p /app               ## 컨테이너 내부에서 명령어 실행(일회성)
WORKDIR /app                    ## 디렉터리 이동
COPY ./requirements.txt /app/   ## 현 디렉터리에 있는 파일 복사
RUN pip install -r requirements.txt
CMD ["python", "main.py"]       ## 컨테이너 프로그램 실행
```

교재 예제파일

```bash
git clone https://github.com/PacktPublishing/Learn-Docker---Fundamentals-of-Docker-19.x-Second-Edition fod-solution
```

### 연습문제





[이미지 스크래치 빌드](https://docs.docker.com/build/building/base-images/)


# DAY 3


# 링크

[도커 vs 포드만](https://www.redhat.com/ko/topics/containers/what-is-podman)

[ostree](https://github.com/ostreedev/ostree)

[overlayfs(unionfs)](https://docs.kernel.org/filesystems/overlayfs.html)

[deb(apt) mirror-1](https://www.debian.org/mirror/ftpmirror)
[apt-mirror](https://manpages.org/debmirror)

# 확인사항

[ ] deb패키지 미러 사용하시는지?
[ ] 실습/이론 비율(80, 20)
[ ] 랩 활용 범위(runtime, kubernetes)
[ ] 배경 지식은 필요 없는지?