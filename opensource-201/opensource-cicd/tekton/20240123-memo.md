# day 1

- __이름:__ 최국현
- __메일:__ <tang@linux.com>


교재는 PDF로 배포가 되었습니다. 메모 내용은 아래 주소에서 확인이 가능 합니다.
1. https://github.com/tangt64/training_memos/tree/main/opensource-201/opensource-cicd/tekton
>
2. https://wbd.ms/share/v2/aHR0cHM6Ly93aGl0ZWJvYXJkLm1pY3Jvc29mdC5jb20vYXBpL3YxLjAvd2hpdGVib2FyZHMvcmVkZWVtLzZkOGNjNTQzOGRhODQ0ODZhMjU0ZDVjMjhiNWY1ODhjX0JCQTcxNzYyLTEyRTAtNDJFMS1CMzI0LTVCMTMxRjQyNEUzRF81MTQ2NjBmNC1hOTg5LTRhY2QtYjMwNi04MWRlNDZlZWY3YTg=

__교육시간:__ 50분 간격 + __15분__ 쉬는시간<br/>
__점심시간:__ 12시 00분 ~ 01시 20분(20분까지는 오세요)<br/>
__집에가는 시간:__ 18시 20분 :)<br/>



## 테크톤 소개

1. YAML
데이터 선언, 쿠버네티스, 오픈스택(Heat), 앤서벌, 솔트 이러한 자동화 도구.

2. TOML(=INI)
설정 파일. 이전에 사용하던 INI형식이나 혹은 Apacge설정 형식을 대신. 추가적으로 데이터 선언이 가능한 문법.

3. JSON
이전에는 JSON기반으로 자동화 및 API 데이터(payload)를 관리 및 처리. 테크톤도 내부적으로 JSON으로 데이터 처리. 


결론은 테크톤도 외부에서 데이터 입력은 YAML, 처리는 JSON 형식으로 처리. 


## 테크톤/젠킨스

1. 테크톤 입문의 문턱이 낮음.(YAML)
2. 젠킨스의 본래 용도는 빌드 시스템(Java,JDK)
3. 작업 관리 및 순서(TOP-DOWN)
4. 쿠버네티스와 통합(YAML+API)

## 설치

설치는 PDF파일 참고 부탁 드립니다.


```bash
ip a s eth0
ip a s eth1

nmcli con mod eth1 ipv4.address 10.10.20.1/16 ipv4.method manual # master
nmcli con mod eth1 ipv4.address 10.10.20.2/16 ipv4.method manual # worker
nmcli con up              # master/worker
nmcli con sh eth1           # master/worker

hostnamectl set-hostname tknmaster.example.com
hostnamectl set-hostname tknworker.example.com

master/node]# cat <<EOF> /etc/hosts
10.10.20.1 tknmaster.example.com tknmaster
10.10.20.2 tknworker.example.com tknworker
EOF

master/node]# cat <<EOF> /etc/modules-load.d/k8s-modules.conf
br_netfilter
overlay
EOF

master/node]# modprobe br_netfilter
master/node]# modprobe overlay
> lsmod | grep -e br_netfilter -e overlay

master/node]# cat <<EOF> /etc/sysctl.d/99-k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

master/node]# sysctl --system

master/node]# cat <<EOF> /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.26/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.26/rpm/repodata/repomd.xml.key
exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
EOF
master/node]# dnf search --disableexcludes=kubernetes kubectl   
master]# dnf install kubeadm kubelet kubectl -y --disableexcludes=kubernetes
node]# dnf install kubeadm kubelet -y --disableexcludes=kubernetes

master/node]# cat <<EOF> /etc/yum.repos.d/libcontainer.repo
[devel_kubic_libcontainers_stable]
name=devel_kubic_libcontainers_stable
type=rpm-md
baseurl=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_9_Stream/
gpgcheck=1
gpgkey=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_9_Stream/repodata/repomd.xml.key
enabled=1
EOF


master/node]# cat <<EOF> /etc/yum.repos.d/crio_stable.repo
[crio]
name=cri-o for derivatives RHEL
type=rpm-md
baseurl=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.24:/1.24.6/CentOS_8/
gpgcheck=1
gpgkey=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.24:/1.24.6/CentOS_8/repodata/repomd.xml.key
enabled=1
EOF
master]# dnf repolist
master]# dnf search crio cri-o
master/node]# dnf install cri-o -y
master/node]# systemctl enable --now crio
master/node]# systemctl is-active crio
> active
systemctl stop firewalld
systemctl disable firewalld

dnf install iproute-tc

sed -i '/ swap / s/^/#/' /etc/fstab
sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config

systemctl status crio
systemctl is-active firewalld

getenforce
setenforce 0

swapon -s
swapoff -a

master]# kubeadm init --apiserver-advertise-address=10.10.20.1 --pod-network-cidr=10.10.0.0/16 --service-cidr=192.168.0.0/16 
> kubeadm join 10.10.20.1:6443 --token kzu7ci.jylu1yzdcwt85c20 \
        --discovery-token-ca-cert-hash sha256:15a5b5e9c5463ca9c359ec96c8677ddd62615fe3afcf986e4b6703e6cbcdef0b
systemctl enable --now kubelet

master]# export KUBECONFIG=/etc/kubernetes/admin.conf
master]# kubectl get pods -A
master]# kubectl get nodes

master]# kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
master]# wget https://raw.githubusercontent.com/tangt64/duststack-k8s-auto/master/roles/cni/cni-calico/templates/custom-resources.yaml
master]# vi custom-resources.yaml
> cidr: 10.10.0.0/16
master]# kubectl apply -f custom-resources.yaml

master]# kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
master]# wget https://github.com/tektoncd/cli/releases/download/v0.32.0/tkn_0.32.0_Linux_x86_64.tar.gz 
master]# kubectl apply --filename https://storage.googleapis.com/tekton-releases/dashboard/latest/release.yaml


master]# dnf install git -y
master]# git clone https://github.com/PacktPublishing/Building-CI-CD-systems-using-Tekton
master]# cd /root/Building-CI-CD-systems-using-Tekton/assessments/chapter-4
master]# kubectl apply -f hello.yaml
master]# mkdir ~/bin/
master]# tar -C ~/bin/ tkn_0.32.0_Linux_x86_64.tar.gz
master]# tkn task list
```

## 테크톤 소개 및 랩

[테크톤 웹 사이트](https://tekton.dev/docs/)
[테크톤 컨셉](https://tekton.dev/docs/concepts/concept-model/)

```bash
kubectl completion bash > kubectl.sh
tkn completion bash > tkn.sh
source kubectl.sh
source tkn.sh
```

- tkn: 테크톤 전용 명령어. kubectl하고 별도록 사용.
- kubectl: 바닐라 ctl명령어에서 조회는 가능. 하지만, 실행은 불가능.


```yaml
vi hello.yaml
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: hello
spec:
  steps:
    - name: welcome-message
      image: quay.io/centos/centos
      command:
        - /bin/bash
        - -c
        - echo "Hello World"
    - name: your-name
      image: quay.io/centos/centos
      command:
        - /bin/bash
        - -c
        - echo "CHOI GOOKHYUN"
    - name: timedate
      image: quay.io/centos/centos
      command:
        - /bin/bash
        - -c
        - timedatectl
```
```bash
kubectl apply -f hello.yaml
kubectl get tasks
tkn task list
tkn task start hello
kubectl get pod

kubectl logs pods/hello-run-jz45t-pod
tkn task logs hello
tkn task start hello --showlog
```

```yaml
vi demo/script.yaml
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: demo-script
spec:
  steps:
    - name: run-test-demo-script
      image: quay.io/centos/centos:stream9
      script: |
        #!/usr/bin/env bash
          dnf install httpd
          dnf install vsftpd
          ping -c10 yahoo.com
```

```yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: demo-script-param
spec:
  params:
  - name: dns
    type: string
    default: 8.8.4.4
  - name: package1
    type: string
    default: iputils
  - name: package2
    type: string
    default: httpd
  - name: targetSrv
    type: string  
    default: 8.8.8.8

  steps:
    - name: set-dns
      image: quay.io/centos/centos:stream9
      script: |
        #!/usr/bin/env bash
        echo "nameserver $(params.dns)" > /etc/resolv.conf

    - name: run-demo-script
      image: quay.io/centos/centos:stream9
      script: |
        #!/usr/bin/env bash
        dnf install -y $(params.package1)
        dnf install -y $(params.package2)
        ping -c10 $(params.targetSrv)
```        

```yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: shared-home
spec:
  steps:
    - name: write
      image: registry.access.redhat.com/ubi8/ubi-minimal
      script: |
        cd /tekton/home/
        echo $(pwd)
        echo "Secret Message" > message.txt
        ls -l /tekton/home/
    - name: read
      image: registry.access.redhat.com/ubi8/ubi-minimal
      script: |
        cd /tekton/home/
        echo $(pwd)
        cat /tekton/home/message.txt
        ls -l
```

## 연습문제

- 간단하게 테스크 "hello world" 생성
- 첫번째 작업은 사용자 이름 출력
- 패키지 설치 작업
  + httpd
  + vsftpd
  + squid
  + git
  + 배열로 처리해도 상관 없음
- 기본값 설정
  + 사용자가 별도로 값을 입력하지 않으면 아래의 값으로 작업 수행
    * 기본 사용자 이름은 "tektonuser"
    * 기본 패키지 httpd으로 처리 및 설치
- 컨테이너 1번에서 2번으로 다음과 같은 데이터 공유
  + https://github.com/PacktPublishing/Building-CI-CD-systems-using-Tekton.git
  + 위의 클론 버전으로 /home/tekton를 통해서 컨테이너 2번에 전달
  
  ```yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: demo-script-param    ## 테스크 이름, tkn task list
spec:                        ## /tekton/home/
  params:
    -name: blahblah
     type:
     default: 
  steps:
    - command: git clone https://github.com/PacktPublishing/Building-CI-CD-systems-using-Tekton.git /tekton/home/


# DAY 2

```yaml
---
apiVersion: tekton.dev/vbeta1
kind: Task
metadata:
  name: demo-results
spec:
  results:
    - name: message
      description: Message to be shared
  steps:
    - name: write
      image: quay.io/centos/centos
      command:
        - /bin/bash
      args:
        - -c
        - echo "Secret Message" | base64 > $(results.message.path)
    - name: read
      image: quay.io/centos/centos
      command:
        - /bin/bash
      args:
        - -c
        - cat $(results.message.path)
    - name: pwd
      image: quay.io/centos/centos
      command:
        - /bin/bash
      args:
        - -c
        - cd $(results.message.path) && pwd
```


```yaml
# kubectl get configmap
# kubectl create -f 
apiVersion: v1
kind: ConfigMap
metadata:
  name: colors-map
data:
  error: "\e[31m"
  info: "\e[34m"
  debug: "\e[32m"
```


## 파이프라인


- 작업(task)에 대한 모음집(collection)
  + pipeline = collection
- 파이프라인은 작업를 직접적으로 소유하고 있지 않음
  + taskRef
- 파이프라인에서 시작 조건 사용 가능
  + before, after
- tkn, kubectl에서 자원 확인이 가능
  + tkn pipeline list
  + kubectl get pipeline


```yaml
# https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/Makefile
# https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_shared.c
# https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_static_a.c
# https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_static_b.c
# https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/main.c

apiVersion: tekton.dev/vbeta1
kind: Task
metadata:
  name: demo-pipeline-tasks
spec:
  steps:
    - name: git-clone
      image: quay.io/centos/centos:stream9
      script: |
      #!/usr/bin/env bash
        echo 8.8.8.8 > /etc/resolve.conf
        dnf install git wget -y
        wget -o /tekton/home/Makefile https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/Makefile
        wget -o /tekton/home/libmy_shared.c https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_shared.c
        wget -o /tekton/home/libmy_static_a.c https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_static_a.c
        wget -o /tekton/home/libmy_static_b.c https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/libmy_static_b.c
        wget -o /tetkon/home/main.c https://raw.githubusercontent.com/tangt64/training_memos/main/opensource-201/opensource-cicd/tekton/materials/main.c
#    - name: source-compile
#      image:
#    - name: binary-run
#      image:

```