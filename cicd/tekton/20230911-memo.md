# day 1

__이름:__ 최국현

__메일:__ <tang@linux.com>


교재는 PDF로 배포가 되었습니다. 메모 내용은 아래 주소에서 확인이 가능 합니다.
>https://github.com/tangt64/training_memos/cicd/tekton
>https://jamboard.google.com/d/1fUcoABnqDUjnWc6UegqNHT2X5aICT-5qLU3Ss6wdFZk/edit?usp=sharing

__교육시간:__ 50분 간격 + __15분__ 쉬는시간<br/>
__점심시간:__ 11시 40분 ~ 01시 00분(20분까지는 오세요)<br/>
__집에가는 시간:__ 17시 50분 :)<br/>

### ISO파일 내려받기

https://rockylinux.org/download
>최소이미지로 내려받기

레드햇 호환 리눅스(더 이상 100% 버그 클론 불가능)
- alma linux는 ABI/kABI호환성 유지
- Rocky, Oracle, SuSE는 CIQ구성(현재 부정적인 평가가 더 많음)


master/node-eth0(DHCP)
---
hostname: master.example.com<br/>
hostname: node1.example.com

master-eth1(Static)
---
IP: 192.168.90.250/24<br/>
GW: NA

node1-eth1(Static)
---
IP: 192.168.90.110/24<br/>
GW: NA


### 쿠버네티스 설치

윈도우 터미널 프로그램
---
https://apps.microsoft.com/store/detail/windows-terminal/9N0DX20HK701?hl=ko-kr&gl=kr&rtc=1

모든 노드에는 최소 2개의 네트워크가 구성.

- worker노드에는 external(SVC), internal(API)
- master노드에는 external(Management, Container Image), internal(API)


```bash
ip link
nmcli dev
nmcli con sh
> NAME  UUID                                  TYPE      DEVICE                                                               eth0  
> 8dc5bdc8-a8d2-3340-b31f-00981cd45556  ethernet  eth0                                                                 eth1  
> f22800d2-80ce-3ebb-a147-b68d12d39feb  ethernet  eth1   

ip a s eth0
ip a s eth1

nmcli con mod eth1 ipv4.address 192.168.90.250/24 ipv4.method manual
nmcli con down
nmcli con up 
nmcli con sh eth1
ip a s eth1    

nmtui edit eth1
nmcli con up eth1
ip a s eth1


master/node]# cat <<EOF> /etc/hosts
192.168.90.250 master.example.com master
192.168.90.110 node.example.com node
EOF

master/node]# cat <<EOF> /etc/modules-load.d/k8s-modules.conf
br_netfilter
overlay
EOF

master/node]# modprobe br_netfilter
master/node]# modprobe overlay
> lsmod | grep -e br_netfilter -e overlay

master/node]# cat <<EOF> /etc/sysctl.d/99-k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

master/node]# sysctl --system

master/node]# cat <<EOF> /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.26/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.26/rpm/repodata/repomd.xml.key
exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
EOF
master/node]# dnf search --disableexcludes=kubernetes kubectl   


master]# dnf install kubeadm kubelet kubectl -y --disableexcludes=kubernetes
node]# dnf install kubeadm kubelet -y --disableexcludes=kubernetes
```

### 런타임 구성 및 설치

```bash
master/node]# cat <<EOF> /etc/yum.repos.d/libcontainer.repo
[devel_kubic_libcontainers_stable]
name=devel_kubic_libcontainers_stable
type=rpm-md
baseurl=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_9_Stream/
gpgcheck=1
gpgkey=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_9_Stream/repodata/repomd.xml.key
enabled=1
EOF


master/node]# cat <<EOF> /etc/yum.repos.d/crio_stable.repo
[crio]
name=cri-o for derivatives RHEL
type=rpm-md
baseurl=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.24:/1.24.6/CentOS_8/
gpgcheck=1
gpgkey=https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.24:/1.24.6/CentOS_8/repodata/repomd.xml.key
enabled=1
EOF
master]# dnf repolist
master]# dnf search crio cri-o
master/node]# dnf install cri-o -y
master/node]# systemctl enable --now crio
master/node]# systemctl is-active crio
> active
```


### 기타 설정

master/node에 적용.

```bash
systemctl stop firewalld
systemctl disable firewalld

dnf install iproute-tc

sed -i '/ swap / s/^/#/' /etc/fstab
sed -i s/^SELINUX=.*$/SELINUX=permissive/ /etc/selinux/config
```


### 최종 1

```bash
systemctl status crio
systemctl is-active firewalld

getenforce
setenforce 0

swapon -s
swapoff -a

## kubeadm init
1. cri-o
2. cri-docker
3. containerd

## 192.168.90.250, eth1 interface


master/node]# curl -o /etc/containers/policy.json https://raw.githubusercontent.com/tangt64/training_memos/main/opensource/kubernetes-101/files/policy.json
master]# kubeadm init --apiserver-advertise-address=192.168.90.250 \
--pod-network-cidr=192.168.0.0/16 \
--service-cidr=10.90.0.0/16 
> kubeadm join 192.168.90.250:6443 --token kzu7ci.jylu1yzdcwt85c20 \
        --discovery-token-ca-cert-hash sha256:15a5b5e9c5463ca9c359ec96c8677ddd62615fe3afcf986e4b6703e6cbcdef0b
master]# systemctl enable --now kubelet
node]# kubeadm join 192.168.90.250:6443 --token kzu7ci.jylu1yzdcwt85c20 \
        --discovery-token-ca-cert-hash sha256:15a5b5e9c5463ca9c359ec96c8677ddd62615fe3afcf986e4b6703e6cbcdef0b
master]# export KUBECONFIG=/etc/kubernetes/admin.conf
master]# kubectl get pods -A
master]# kubectl get nodes
master]# kubeadm token create --print-join-command
> kubeadm join 192.168.90.250:6443 --token 7tot4i.ry9xoeeum6ffw6yu --discovery-token-ca-cert-hash sha256:15a5b5e9c5463ca9c359ec96c8677ddd62615fe3afcf986e4b6703e6cbcdef0b

```

노드 2대
```bash
master/node]# vi /etc/hosts
192.168.90.250 master.example.com master
192.168.90.110 node1.example.com node1
192.168.90.120 node2.example.com node2


master]# hostnamectl set-hostname master.example.com
node1]# hostnamectl set-hostname node1.example.com
node2]# hostnamectl set-hostname node2.example.com
```


### 확인 명령어

```bash
master]# export KUBECONFIG=/etc/kubernetes/admin.conf
master]# kubectl get pods -A
master]# kubectl get nodes
```

### POD 네트워크 생성

```bash
master]# kubectl delete -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
master]# kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/tigera-operator.yaml
master]# wget https://raw.githubusercontent.com/tangt64/duststack-k8s-auto/master/roles/cni/cni-calico/templates/custom-resources.yaml
master]# vi custom-resources.yaml
> cidr: 192.168.0.0/16
master]# kubectl apply -f custom-resources.yaml
master]# kubectl get pods -A
> calico-apiserver   calico-apiserver-7cf9cc6788-9q27x            1/1     Running   0          9m26s
> calico-apiserver   calico-apiserver-7cf9cc6788-dcvvs            1/1     Running   0          9m26s
> calico-system      calico-kube-controllers-65bfc7f4d9-2lstq     1/1     Running   0          11m
> calico-system      calico-node-5mwks                            1/1     Running   0          11m
> calico-system      calico-node-qqllc                            1/1     Running   0          11m
> calico-system      calico-typha-5d7cdf588-q9x2z                 1/1     Running   0          11m
> calico-system      csi-node-driver-m8ht6                        2/2     Running   0          11m
> calico-system      csi-node-driver-zm6r6                        2/2     Running   0          11m

master/node]# curl -o /etc/containers/policy.json https://raw.githubusercontent.com/tangt64/training_memos/main/opensource/kubernetes-101/files/policy.json
```



### to 승훈님 :)


```bash
master/node]# nmtui edit eth1
> IPV4: 10.10.10.250
> IPV4: 10.10.10.110
master/node]# vi /etc/hosts
master/node]# nmcli con up eth1
master/node]# ip a s eth1

master]# kubeadm init --apiserver-advertise-address=10.10.10.250 \
--pod-network-cidr=10.10.0.0/16 \
--service-cidr=10.90.0.0/16 
master]# vi custom-resources.yaml
> cidr: 10.10.0.0/16
```


코드받기 및 테스트 + 테크톤
---
```bash

master]# kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
master]# wget https://github.com/tektoncd/cli/releases/download/v0.32.0/tkn_0.32.0_Linux_x86_64.tar.gz 
master]# kubectl apply --filename https://github.com/tektoncd/dashboard/releases/latest/download/tekton-dashboard-release.yaml


master]# dnf install git -y
master]# git clone https://github.com/PacktPublishing/Building-CI-CD-systems-using-Tekton
master]# cd /root/Building-CI-CD-systems-using-Tekton/assessments/chapter-4
master]# kubectl apply -f hello.yaml
master]# mkdir ~/bin/
master]# tar -C ~/bin/ tkn_0.32.0_Linux_x86_64.tar.gz
master]# tkn task list
> NAME              DESCRIPTION   AGE
> more-than-hello                 16 minutes ago    


## 만약, hello 가 올바르게 생성이 안되면 아래 명령어 실행

master]# kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io config.webhook.pipeline.tekton.dev
master]# kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io validation.webhook.pipeline.tekton.dev
master]# kubectl delete mutatingwebhookconfigurations.admissionregistration.k8s.io webhook.pipeline.tekton.dev
```

# day 2

## 에디터 설정

```bash

## Linux
master]# curl -sS https://webi.sh/vim-ale | sh

## mac
master]# curl -sS https://webi.sh/vim-ale | sh


master]# dnf install epel-release -y
master]# dnf search yamllint
> yamllint.noarch : A linter for YAML files     
master]# dnf install yamllint -y

```


# 질문


```
  BC  --->   DC    RS

source ---> tekton ---<compile> ---<package> ---> argocd ---> deployment(rs) ---> svc 
             \                       /
              `---------------------'
                       PIPE
Tekton(pipe)
````

1. 테크톤이 아르고나 젠킨스와 비교해서 기능적이나 사용편의적으로 장점 or 차이점이 있나요?

- argo-cd: 배포에 좀 더 초점(tekton+argoCD)
  * 애플리케이션 배포 및 관리
  * 작업(task)를 다루지는 않음
  * k8s.api.deployment
  * YAML, object

- Jenkins-cd(Jenkins-X, Legacy)
  * 덩치가 크고, 쿠버네티스와 통합이 안됨
  * 범용성이 매우 높음
 
- tekton-cd: 
  * 구글, 레드햇 협업
  * task기반으로 명령어 혹은 작업 수행
  * 쿠버네티스와 통합이 됨
  * YAML
  
